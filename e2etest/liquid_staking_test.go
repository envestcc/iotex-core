package e2etest

import (
	"context"
	"encoding/hex"
	"math/big"
	"strings"
	"testing"
	"time"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/iotexproject/go-pkgs/crypto"
	"github.com/iotexproject/go-pkgs/hash"
	"github.com/iotexproject/iotex-core/action"
	"github.com/iotexproject/iotex-core/action/protocol"
	"github.com/iotexproject/iotex-core/action/protocol/account"
	accountutil "github.com/iotexproject/iotex-core/action/protocol/account/util"
	"github.com/iotexproject/iotex-core/action/protocol/execution"
	"github.com/iotexproject/iotex-core/action/protocol/rewarding"
	"github.com/iotexproject/iotex-core/action/protocol/rolldpos"
	"github.com/iotexproject/iotex-core/actpool"
	"github.com/iotexproject/iotex-core/blockchain"
	"github.com/iotexproject/iotex-core/blockchain/block"
	"github.com/iotexproject/iotex-core/blockchain/blockdao"
	"github.com/iotexproject/iotex-core/blockchain/genesis"
	"github.com/iotexproject/iotex-core/blockindex"
	"github.com/iotexproject/iotex-core/config"
	"github.com/iotexproject/iotex-core/db"
	"github.com/iotexproject/iotex-core/state/factory"
	"github.com/iotexproject/iotex-core/test/identityset"
	"github.com/iotexproject/iotex-core/testutil"
	"github.com/iotexproject/iotex-proto/golang/iotextypes"
	"github.com/stretchr/testify/require"
	"golang.org/x/exp/slices"
)

const (
	_liquidStakingContractByteCode = `60806040523480156200001157600080fd5b5060405180604001604052806009815260200168109d58dad95d13919560ba1b815250604051806040016040528060038152602001621092d560ea1b81525081600090816200006191906200019b565b5060016200007082826200019b565b5050506200008d62000087620000a060201b60201c565b620000a4565b6006805460ff60a01b1916905562000267565b3390565b600680546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b634e487b7160e01b600052604160045260246000fd5b600181811c908216806200012157607f821691505b6020821081036200014257634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156200019657600081815260208120601f850160051c81016020861015620001715750805b601f850160051c820191505b8181101562000192578281556001016200017d565b5050505b505050565b81516001600160401b03811115620001b757620001b7620000f6565b620001cf81620001c884546200010c565b8462000148565b602080601f831160018114620002075760008415620001ee5750858301515b600019600386901b1c1916600185901b17855562000192565b600085815260208120601f198616915b82811015620002385788860151825594840194600190910190840162000217565b5085821015620002575787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b613dc980620002776000396000f3fe6080604052600436106102925760003560e01c806378bfca101161015a578063c87b56dd116100c1578063e0028ecf1161007a578063e0028ecf146107dd578063e449f341146107fd578063e985e9c51461081d578063eb0ffb2e14610866578063f0b56b5d14610886578063f2fde38b1461089c57600080fd5b8063c87b56dd14610741578063c8e7792314610761578063cd0a02d014610781578063d0949f9914610794578063d6605fd8146107aa578063d6819bcc146107ca57600080fd5b8063a22cb46511610113578063a22cb4651461069b578063ad46fc64146106bb578063b2383e55146106db578063b88d4fde146106ee578063b8f4bd7b1461070e578063bbe33ea51461072e57600080fd5b806378bfca10146105f15780638456cb591461061e5780638da5cb5b1461063357806393b6ef591461065157806395d89b41146106715780639f7d5b001461068657600080fd5b806342842e0e116101fe5780635d36598f116101b75780635d36598f1461053c5780636198e3391461055c5780636352211e1461057c5780636faa5c271461059c57806370a08231146105bc578063715018a6146105dc57600080fd5b806342842e0e14610458578063431cd92a1461047857806343e06c59146104ca578063597cc14a146104ea5780635c975abb146104fd5780635ceb8b5b1461051c57600080fd5b80631338736f116102505780631338736f1461039657806323b872dd146103b65780632dc83008146103d65780632e17de78146103f65780633f4ba83a146104165780633fac69af1461042b57600080fd5b8062f714ce1461029757806301ffc9a7146102b957806303459b16146102ee57806306fdde031461031c578063081812fc1461033e578063095ea7b314610376575b600080fd5b3480156102a357600080fd5b506102b76102b236600461341d565b6108bc565b005b3480156102c557600080fd5b506102d96102d4366004613463565b610983565b60405190151581526020015b60405180910390f35b3480156102fa57600080fd5b5061030e610309366004613480565b6109d5565b6040519081526020016102e5565b34801561032857600080fd5b506103316109fb565b6040516102e591906134e9565b34801561034a57600080fd5b5061035e610359366004613480565b610a8d565b6040516001600160a01b0390911681526020016102e5565b34801561038257600080fd5b506102b76103913660046134fc565b610ab4565b3480156103a257600080fd5b506102b76103b1366004613528565b610bc9565b3480156103c257600080fd5b506102b76103d136600461354a565b610c3c565b3480156103e257600080fd5b506102b76103f13660046135a8565b610c6d565b34801561040257600080fd5b506102b7610411366004613480565b610cdb565b34801561042257600080fd5b506102b7610d8a565b34801561043757600080fd5b5061044b61044636600461361f565b610d9c565b6040516102e59190613660565b34801561046457600080fd5b506102b761047336600461354a565b610f18565b34801561048457600080fd5b50610498610493366004613480565b610f33565b6040805195865260208601949094529284019190915260608301526001600160a01b031916608082015260a0016102e5565b3480156104d657600080fd5b506102d96104e5366004613528565b610fa9565b61030e6104f83660046135a8565b610fc4565b34801561050957600080fd5b50600654600160a01b900460ff166102d9565b34801561052857600080fd5b506102b76105373660046136ea565b61103a565b34801561054857600080fd5b506102b761055736600461361f565b6110e1565b34801561056857600080fd5b506102b7610577366004613480565b611177565b34801561058857600080fd5b5061035e610597366004613480565b6111d9565b3480156105a857600080fd5b5061044b6105b736600461361f565b611239565b3480156105c857600080fd5b5061030e6105d7366004613735565b6113ad565b3480156105e857600080fd5b506102b7611433565b3480156105fd57600080fd5b5061061161060c366004613528565b611445565b6040516102e59190613752565b34801561062a57600080fd5b506102b761157a565b34801561063f57600080fd5b506006546001600160a01b031661035e565b34801561065d57600080fd5b5061030e61066c366004613480565b61158a565b34801561067d57600080fd5b506103316115b5565b34801561069257600080fd5b50600b5461030e565b3480156106a757600080fd5b506102b76106b63660046137ab565b6115c4565b3480156106c757600080fd5b506102b76106d63660046137de565b6115d3565b6102b76106e9366004613528565b61166a565b3480156106fa57600080fd5b506102b7610709366004613877565b611772565b34801561071a57600080fd5b506102b761072936600461393a565b6117aa565b6102b761073c3660046136ea565b611899565b34801561074d57600080fd5b5061033161075c366004613480565b611aa0565b34801561076d57600080fd5b506102b761077c366004613528565b611b13565b61030e61078f366004613990565b611cb8565b3480156107a057600080fd5b5061030e60001981565b3480156107b657600080fd5b506102b76107c5366004613528565b611d82565b61030e6107d83660046139cd565b611e6b565b3480156107e957600080fd5b506102b76107f8366004613528565b611f5d565b34801561080957600080fd5b506102b761081836600461361f565b611fd1565b34801561082957600080fd5b506102d9610838366004613a8e565b6001600160a01b03918216600090815260056020908152604080832093909416825291909152205460ff1690565b34801561087257600080fd5b506102b7610881366004613528565b6120ad565b34801561089257600080fd5b5061030e61ca8081565b3480156108a857600080fd5b506102b76108b7366004613735565b612123565b6108c461219c565b816108ce816121e9565b600083815260086020526040902060028101546108ea9061223e565b156109345760405162461bcd60e51b81526020600482015260156024820152746e6f7420726561647920746f20776974686472617760581b60448201526064015b60405180910390fd5b61093d846122b3565b6109478184612356565b6040516001600160a01b0384169085907fd964a27d45f595739c13d8b1160b57491050cacf3a2e5602207277d6228f64ee90600090a350505050565b60006001600160e01b031982166380ac58cd60e01b14806109b457506001600160e01b03198216635b5e139f60e01b145b806109cf57506301ffc9a760e01b6001600160e01b03198316145b92915050565b60006109e082612415565b6000828152600860205260409020600201546109cf9061223e565b606060008054610a0a90613abc565b80601f0160208091040260200160405190810160405280929190818152602001828054610a3690613abc565b8015610a835780601f10610a5857610100808354040283529160200191610a83565b820191906000526020600020905b815481529060010190602001808311610a6657829003601f168201915b5050505050905090565b6000610a9882612415565b506000908152600460205260409020546001600160a01b031690565b6000610abf826111d9565b9050806001600160a01b0316836001600160a01b031603610b2c5760405162461bcd60e51b815260206004820152602160248201527f4552433732313a20617070726f76616c20746f2063757272656e74206f776e656044820152603960f91b606482015260840161092b565b336001600160a01b0382161480610b485750610b488133610838565b610bba5760405162461bcd60e51b815260206004820152603d60248201527f4552433732313a20617070726f76652063616c6c6572206973206e6f7420746f60448201527f6b656e206f776e6572206f7220617070726f76656420666f7220616c6c000000606482015260840161092b565b610bc48383612474565b505050565b610bd161219c565b81610bdb816121e9565b6000838152600860205260409020610bf2816124e2565b610bfc818461252c565b837f907fece23ce39fbcbceb71e515043fe29408353fbb393b25b35eb8a70a4bad0b84604051610c2e91815260200190565b60405180910390a250505050565b610c463382612614565b610c625760405162461bcd60e51b815260040161092b90613af6565b610bc4838383612692565b610c7561219c565b81610c7f816121e9565b6000838152600860205260409020610c979083612803565b6040516001600160a01b03198316815283907ffec7db38481afeb8686a62ee7bba420143bd43540fe5e57b7316be50bdaa220c9060200160405180910390a2505050565b610ce361219c565b80610ced816121e9565b6000828152600860205260409020610d04816124e2565b610d0d81612906565b15610d515760405162461bcd60e51b81526020600482015260146024820152736e6f7420726561647920746f20756e7374616b6560601b604482015260640161092b565b610d5a816129ab565b60405183907f11725367022c3ff288940f4b5473aa61c2da6a24af7363a1128ee2401e8983b290600090a2505050565b610d926129e6565b610d9a612a40565b565b6060816001600160401b03811115610db657610db6613831565b604051908082528060200260200182016040528015610de957816020015b6060815260200190600190039081610dd45790505b5090506000610df7600b5490565b905060005b83811015610f1057816001600160401b03811115610e1c57610e1c613831565b604051908082528060200260200182016040528015610e45578160200160208202803683370190505b50838281518110610e5857610e58613b43565b6020026020010181905250600060096000878785818110610e7b57610e7b613b43565b9050602002016020810190610e909190613b59565b6001600160a01b03191681526020810191909152604001600090812091505b83811015610f06576000818152602083905260409020548551869085908110610eda57610eda613b43565b60200260200101518281518110610ef357610ef3613b43565b6020908102919091010152600101610eaf565b5050600101610dfc565b505092915050565b610bc483838360405180602001604052806000815250611772565b6000806000806000610f4486612415565b60008681526008602052604081208054600b80549293929091908110610f6c57610f6c613b43565b6000918252602090912060039182020180546001918201549185015460028601549590930154909b919a5091985092965060a01b94509092505050565b6000610fbd610fb88484612a95565b612afc565b9392505050565b6000610fce61219c565b346000610fdb8286612a95565b9050610fe681612b2d565b610ff08185612b79565b60075460405181907f1f44b78b04f7c6f80fc97ae8b196d9e9d7a81663114744f18fe5d073cd70ce4a9061102990889087908b90613b74565b60405180910390a295945050505050565b61104261219c565b60008060005b848110156110d95785858281811061106257611062613b43565b905060200201359250611074836121e9565b6000838152600860205260409020915061108d826124e2565b611097828561252c565b827f907fece23ce39fbcbceb71e515043fe29408353fbb393b25b35eb8a70a4bad0b856040516110c991815260200190565b60405180910390a2600101611048565b505050505050565b6110e961219c565b60008060005b838110156111705784848281811061110957611109613b43565b90506020020135925061111b836121e9565b6000838152600860205260409020915061113482612c19565b61113d82612c63565b60405183907ff27b6ce5b2f5e68ddb2fd95a8a909d4ecf1daaac270935fff052feacb24f184290600090a26001016110ef565b5050505050565b61117f61219c565b80611189816121e9565b60008281526008602052604090206111a081612c19565b6111a981612c63565b60405183907ff27b6ce5b2f5e68ddb2fd95a8a909d4ecf1daaac270935fff052feacb24f184290600090a2505050565b6000818152600260205260408120546001600160a01b0316806109cf5760405162461bcd60e51b8152602060048201526018602482015277115490cdcc8c4e881a5b9d985b1a59081d1bdad95b88125160421b604482015260640161092b565b6060816001600160401b0381111561125357611253613831565b60405190808252806020026020018201604052801561128657816020015b60608152602001906001900390816112715790505b5090506000611294600b5490565b905060005b83811015610f1057816001600160401b038111156112b9576112b9613831565b6040519080825280602002602001820160405280156112e2578160200160208202803683370190505b508382815181106112f5576112f5613b43565b60200260200101819052506000600a600087878581811061131857611318613b43565b905060200201602081019061132d9190613b59565b6001600160a01b03191681526020810191909152604001600090812091505b838110156113a357600081815260208390526040902054855186908590811061137757611377613b43565b6020026020010151828151811061139057611390613b43565b602090810291909101015260010161134c565b5050600101611299565b60006001600160a01b0382166114175760405162461bcd60e51b815260206004820152602960248201527f4552433732313a2061646472657373207a65726f206973206e6f7420612076616044820152683634b21037bbb732b960b91b606482015260840161092b565b506001600160a01b031660009081526003602052604090205490565b61143b6129e6565b610d9a6000612cbb565b60606000821180156114625750600b5461145f8385613bac565b11155b61147e5760405162461bcd60e51b815260040161092b90613bbf565b816001600160401b0381111561149657611496613831565b6040519080825280602002602001820160405280156114eb57816020015b6114d860405180606001604052806000815260200160008152602001600081525090565b8152602001906001900390816114b45790505b50905060005b8281101561157357600b8185018154811061150e5761150e613b43565b9060005260206000209060030201604051806060016040529081600082015481526020016001820154815260200160028201548152505082828151811061155757611557613b43565b602002602001018190525061156c8160010190565b90506114f1565b5092915050565b6115826129e6565b610d9a612d0d565b600061159582612415565b60008281526008602052604090206115ac816124e2565b610fbd81612906565b606060018054610a0a90613abc565b6115cf338383612d50565b5050565b6115db61219c565b6000805b83811015611170578484828181106115f9576115f9613b43565b90506020020135915061160b826121e9565b60008281526008602052604090206116239084612803565b6040516001600160a01b03198416815282907ffec7db38481afeb8686a62ee7bba420143bd43540fe5e57b7316be50bdaa220c9060200160405180910390a26001016115df565b61167261219c565b8161167c816121e9565b600083815260086020526040902061169381612c19565b8054600b805460009190839081106116ad576116ad613b43565b90600052602060002090600302019050848160000154346116ce9190613bac565b146116eb5760405162461bcd60e51b815260040161092b90613beb565b600383015460a01b6001600160a01b0319166000908152600a602090815260408083208584529091529020805460001901905560018101546117309084908790612e1e565b857f1d9c4d2b3e13eb9ac08a42625750ac17ec6ca94b4755c49285e9467b4e48c89d8660405161176291815260200190565b60405180910390a2505050505050565b61177c3383612614565b6117985760405162461bcd60e51b815260040161092b90613af6565b6117a484848484612e6e565b50505050565b6117b261219c565b60008060005b848110156110d9578585828181106117d2576117d2613b43565b9050602002013592506117e4836121e9565b600083815260086020526040902060028101549092506118039061223e565b156118485760405162461bcd60e51b81526020600482015260156024820152746e6f7420726561647920746f20776974686472617760581b604482015260640161092b565b611851836122b3565b61185b8285612356565b6040516001600160a01b0385169084907fd964a27d45f595739c13d8b1160b57491050cacf3a2e5602207277d6228f64ee90600090a36001016117b8565b6118a161219c565b600182116118e25760405162461bcd60e51b815260206004820152600e60248201526d0d2dcecc2d8d2c840d8cadccee8d60931b604482015260640161092b565b3460008080855b8015611a96576000190187878281811061190557611905613b43565b905060200201359350611917846121e9565b60008481526008602052604090209250611930836124e2565b82546003840154600b805460a09290921b918390811061195257611952613b43565b9060005260206000209060030201935083600101548810156119a95760405162461bcd60e51b815260206004820152601060248201526f34b73b30b634b210323ab930ba34b7b760811b604482015260640161092b565b83546119b59088613bac565b96506119c78560010154600019141590565b156119fd576001600160a01b03198116600090815260096020908152604080832085845290915290208054600019019055611a2a565b6001600160a01b031981166000908152600a60209081526040808320858452909152902080546000190190555b8215611a3e57611a39866122b3565b611a8f565b6000196001860155611a5185888a612e1e565b7fb3f4c8ca702dbbd32d9a25ce17b1942a5060284d9d69fc4fcac8fb0397891b128a8a898b604051611a869493929190613c16565b60405180910390a15b50506118e9565b5050505050505050565b6060611aab82612415565b6000611ac260408051602081019091526000815290565b90506000815111611ae25760405180602001604052806000815250610fbd565b80611aec84612ea1565b604051602001611afd929190613c5c565b6040516020818303038152906040529392505050565b611b1b6129e6565b81600003611b5f5760405162461bcd60e51b8152602060048201526011602482015270185b5bdd5b9d081a5cc81a5b9d985b1a59607a1b604482015260640161092b565b6000828152600c6020908152604080832084845290915290205415611bbe5760405162461bcd60e51b81526020600482015260156024820152746475706c6963617465206275636b6574207479706560581b604482015260640161092b565b60408051606081018252838152602080820184815243838501908152600b8054600181018255600082815295517f0175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01db960039092029182015592517f0175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01dba84015590517f0175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01dbb9092019190915554858352600c82528383208584528252918390209190915581518481529081018390527f6b39e3267efcd6611c8d7d2534c4715dcb4824322b90d85540a3a82967b6e7b791015b60405180910390a15050565b6000611cc261219c565b600082118015611cda575034611cd88387613c8b565b145b611cf65760405162461bcd60e51b815260040161092b90613bbf565b6000611d028686612a95565b9050611d0d81612b2d565b600754600101915060005b83811015611d7757611d2a8286612b79565b611d348184613bac565b7f1f44b78b04f7c6f80fc97ae8b196d9e9d7a81663114744f18fe5d073cd70ce4a868989604051611d6793929190613b74565b60405180910390a2600101611d18565b50505b949350505050565b611d8a61219c565b81611d94816121e9565b6000838152600860205260409020611dab81612c19565b8054600b80546000919083908110611dc557611dc5613b43565b9060005260206000209060030201905080600101548511611df85760405162461bcd60e51b815260040161092b90613beb565b600383015460a01b6001600160a01b0319166000908152600a60209081526040808320858452909152902080546000190190558054611e3990849087612e1e565b857fc599168ac63ff28ec278088a2c424383a36ca26c931eb41af05e014f19252ea48660405161176291815260200190565b6000611e7561219c565b34825185611e839190613c8b565b14611ea05760405162461bcd60e51b815260040161092b90613bbf565b6000611eac8585612a95565b9050611eb781612b2d565b600754600101915060005b8351811015611f5457611eee82858381518110611ee157611ee1613b43565b6020026020010151612b79565b611ef88184613bac565b7f1f44b78b04f7c6f80fc97ae8b196d9e9d7a81663114744f18fe5d073cd70ce4a858381518110611f2b57611f2b613b43565b60200260200101518888604051611f4493929190613b74565b60405180910390a2600101611ec2565b50509392505050565b611f656129e6565b43600b611f728484612a95565b81548110611f8257611f82613b43565b9060005260206000209060030201600201819055507f6b39e3267efcd6611c8d7d2534c4715dcb4824322b90d85540a3a82967b6e7b78282604051611cac929190918252602082015260400190565b611fd961219c565b60008060005b8381101561117057848482818110611ff957611ff9613b43565b90506020020135925061200b836121e9565b60008381526008602052604090209150612024826124e2565b61202d82612906565b156120715760405162461bcd60e51b81526020600482015260146024820152736e6f7420726561647920746f20756e7374616b6560601b604482015260640161092b565b61207a826129ab565b60405183907f11725367022c3ff288940f4b5473aa61c2da6a24af7363a1128ee2401e8983b290600090a2600101611fdf565b6120b56129e6565b600019600b6120c48484612a95565b815481106120d4576120d4613b43565b9060005260206000209060030201600201819055507f099df2bf9247b43481cf1b791a4dd5fa1220c40c62940da539082fbcb30241d68282604051611cac929190918252602082015260400190565b61212b6129e6565b6001600160a01b0381166121905760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b606482015260840161092b565b61219981612cbb565b50565b600654600160a01b900460ff1615610d9a5760405162461bcd60e51b815260206004820152601060248201526f14185d5cd8589b194e881c185d5cd95960821b604482015260640161092b565b6121f2816111d9565b6001600160a01b0316336001600160a01b0316146121995760405162461bcd60e51b81526020600482015260096024820152683737ba1037bbb732b960b91b604482015260640161092b565b6000600019820361228a5760405162461bcd60e51b81526020600482015260166024820152751b9bdd08185b881d5b9cdd185ad95908189d58dad95d60521b604482015260640161092b565b600061229861ca8084613bac565b90504381116122aa5750600092915050565b43900392915050565b60006122be826111d9565b90506122ce816000846001612f33565b6122d7826111d9565b600083815260046020908152604080832080546001600160a01b03199081169091556001600160a01b0385168085526003845282852080546000190190558785526002909352818420805490911690555192935084927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef908390a45050565b6000600b83600001548154811061236f5761236f613b43565b600091825260208220600390910201546040519092506001600160a01b0384169083908381818185875af1925050503d80600081146123ca576040519150601f19603f3d011682016040523d82523d6000602084013e6123cf565b606091505b50509050806117a45760405162461bcd60e51b81526020600482015260126024820152713330b4b632b2103a37903a3930b739b332b960711b604482015260640161092b565b6000818152600260205260409020546001600160a01b03166121995760405162461bcd60e51b8152602060048201526018602482015277115490cdcc8c4e881a5b9d985b1a59081d1bdad95b88125160421b604482015260640161092b565b600081815260046020526040902080546001600160a01b0319166001600160a01b03841690811790915581906124a9826111d9565b6001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45050565b6002810154600019146121995760405162461bcd60e51b81526020600482015260126024820152713737ba10309039ba30b5b2b2103a37b5b2b760711b604482015260640161092b565b8154600383015460a01b61253f84612906565b8310156125815760405162461bcd60e51b815260206004820152601060248201526f34b73b30b634b210323ab930ba34b7b760811b604482015260640161092b565b60006125b1600b848154811061259957612599613b43565b90600052602060002090600302016000015485612a95565b90506125bc81612b2d565b60001960018681018290556001600160a01b03199390931660008181526009602090815260408083209783529681528682208054909401909355968390558652600a8152838620918652529220805490920190915550565b600080612620836111d9565b9050806001600160a01b0316846001600160a01b0316148061266757506001600160a01b0380821660009081526005602090815260408083209388168352929052205460ff165b80611d7a5750836001600160a01b031661268084610a8d565b6001600160a01b031614949350505050565b826001600160a01b03166126a5826111d9565b6001600160a01b0316146126cb5760405162461bcd60e51b815260040161092b90613ca2565b6001600160a01b03821661272d5760405162461bcd60e51b8152602060048201526024808201527f4552433732313a207472616e7366657220746f20746865207a65726f206164646044820152637265737360e01b606482015260840161092b565b61273a8383836001612f33565b826001600160a01b031661274d826111d9565b6001600160a01b0316146127735760405162461bcd60e51b815260040161092b90613ca2565b600081815260046020908152604080832080546001600160a01b03199081169091556001600160a01b0387811680865260038552838620805460001901905590871680865283862080546001019055868652600290945282852080549092168417909155905184937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a4505050565b61280c826124e2565b8154600383015460a01b6001600160a01b0319808416908216036128425760405162461bcd60e51b815260040161092b90613beb565b600184015460001914612899576001600160a01b03198181166000908152600960208181526040808420878552825280842080546000190190559387168352908152828220858352905220805460010190556128df565b6001600160a01b03198181166000908152600a60208181526040808420878552825280842080546000190190559387168352908152828220858352905220805460010190555b505060039190910180546bffffffffffffffffffffffff191660a09290921c919091179055565b600181015460009060001981036129585760405162461bcd60e51b81526020600482015260166024820152751b9bdd08185b881d5b9b1bd8dad95908189d58dad95d60521b604482015260640161092b565b6000600b84600001548154811061297157612971613b43565b9060005260206000209060030201600101548261298e9190613bac565b90504381116129a1575060009392505050565b4390039392505050565b436002820155600381015460a01b6001600160a01b031916600090815260096020908152604080832093548352929052208054600019019055565b6006546001600160a01b03163314610d9a5760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604482015260640161092b565b612a48612ffc565b6006805460ff60a01b191690557f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa335b6040516001600160a01b03909116815260200160405180910390a1565b6000828152600c6020908152604080832084845290915281205480612af25760405162461bcd60e51b8152602060048201526013602482015272696e76616c6964206275636b6574207479706560681b604482015260640161092b565b6000198101611d7a565b600043600b8381548110612b1257612b12613b43565b90600052602060002090600302016002015411159050919050565b612b3681612afc565b6121995760405162461bcd60e51b8152602060048201526014602482015273696e616374697665206275636b6574207479706560601b604482015260640161092b565b6007805460019081018083556040805160808101825286815260001960208083018281528385019283526001600160a01b0319891660608501818152600097885260088452868820955186559151858901559251600285015551600390930180546bffffffffffffffffffffffff191660a09490941c939093179092558352600a81528183208784529052902080549091019055546115cf90339061304c565b6001810154600019146121995760405162461bcd60e51b81526020600482015260126024820152713737ba1030903637b1b5b2b2103a37b5b2b760711b604482015260640161092b565b805460038201544360019384015560a01b6001600160a01b0319166000818152600a60209081526040808320858452825280832080546000190190559282526009815282822093825292909252902080549091019055565b600680546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b612d1561219c565b6006805460ff60a01b1916600160a01b1790557f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a258612a783390565b816001600160a01b0316836001600160a01b031603612db15760405162461bcd60e51b815260206004820152601960248201527f4552433732313a20617070726f766520746f2063616c6c657200000000000000604482015260640161092b565b6001600160a01b03838116600081815260056020908152604080832094871680845294825291829020805460ff191686151590811790915591519182527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a3505050565b6000612e2a8383612a95565b9050612e3581612b2d565b600384015460a01b6001600160a01b0319166000908152600a602090815260408083208484529091529020805460010190559092555050565b612e79848484612692565b612e8584848484613066565b6117a45760405162461bcd60e51b815260040161092b90613ce7565b60606000612eae83613164565b60010190506000816001600160401b03811115612ecd57612ecd613831565b6040519080825280601f01601f191660200182016040528015612ef7576020820181803683370190505b5090508181016020015b600019016f181899199a1a9b1b9c1cb0b131b232b360811b600a86061a8153600a8504945084612f0157509392505050565b80600114612f835760405162461bcd60e51b815260206004820152601f60248201527f6261746368207472616e73666572206973206e6f7420737570706f7274656400604482015260640161092b565b6001600160a01b0383161580612fab5750600082815260086020526040902060020154600019145b612ff75760405162461bcd60e51b815260206004820152601e60248201527f63616e6e6f74207472616e7366657220756e7374616b656420746f6b656e0000604482015260640161092b565b6117a4565b600654600160a01b900460ff16610d9a5760405162461bcd60e51b815260206004820152601460248201527314185d5cd8589b194e881b9bdd081c185d5cd95960621b604482015260640161092b565b6115cf82826040518060200160405280600081525061323c565b60006001600160a01b0384163b1561315c57604051630a85bd0160e11b81526001600160a01b0385169063150b7a02906130aa903390899088908890600401613d39565b6020604051808303816000875af19250505080156130e5575060408051601f3d908101601f191682019092526130e291810190613d76565b60015b613142573d808015613113576040519150601f19603f3d011682016040523d82523d6000602084013e613118565b606091505b50805160000361313a5760405162461bcd60e51b815260040161092b90613ce7565b805181602001fd5b6001600160e01b031916630a85bd0160e11b149050611d7a565b506001611d7a565b60008072184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b83106131a35772184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b830492506040015b6d04ee2d6d415b85acef810000000083106131cf576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc1000083106131ed57662386f26fc10000830492506010015b6305f5e1008310613205576305f5e100830492506008015b612710831061321957612710830492506004015b6064831061322b576064830492506002015b600a83106109cf5760010192915050565b613246838361326f565b6132536000848484613066565b610bc45760405162461bcd60e51b815260040161092b90613ce7565b6001600160a01b0382166132c55760405162461bcd60e51b815260206004820181905260248201527f4552433732313a206d696e7420746f20746865207a65726f2061646472657373604482015260640161092b565b6000818152600260205260409020546001600160a01b03161561332a5760405162461bcd60e51b815260206004820152601c60248201527f4552433732313a20746f6b656e20616c7265616479206d696e74656400000000604482015260640161092b565b613338600083836001612f33565b6000818152600260205260409020546001600160a01b03161561339d5760405162461bcd60e51b815260206004820152601c60248201527f4552433732313a20746f6b656e20616c7265616479206d696e74656400000000604482015260640161092b565b6001600160a01b038216600081815260036020908152604080832080546001019055848352600290915280822080546001600160a01b0319168417905551839291907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef908290a45050565b6001600160a01b038116811461219957600080fd5b6000806040838503121561343057600080fd5b82359150602083013561344281613408565b809150509250929050565b6001600160e01b03198116811461219957600080fd5b60006020828403121561347557600080fd5b8135610fbd8161344d565b60006020828403121561349257600080fd5b5035919050565b60005b838110156134b457818101518382015260200161349c565b50506000910152565b600081518084526134d5816020860160208601613499565b601f01601f19169290920160200192915050565b602081526000610fbd60208301846134bd565b6000806040838503121561350f57600080fd5b823561351a81613408565b946020939093013593505050565b6000806040838503121561353b57600080fd5b50508035926020909101359150565b60008060006060848603121561355f57600080fd5b833561356a81613408565b9250602084013561357a81613408565b929592945050506040919091013590565b80356001600160a01b0319811681146135a357600080fd5b919050565b600080604083850312156135bb57600080fd5b823591506135cb6020840161358b565b90509250929050565b60008083601f8401126135e657600080fd5b5081356001600160401b038111156135fd57600080fd5b6020830191508360208260051b850101111561361857600080fd5b9250929050565b6000806020838503121561363257600080fd5b82356001600160401b0381111561364857600080fd5b613654858286016135d4565b90969095509350505050565b6000602080830181845280855180835260408601915060408160051b87010192508387016000805b838110156136dc57888603603f19018552825180518088529088019088880190845b818110156136c65783518352928a0192918a01916001016136aa565b5090975050509386019391860191600101613688565b509398975050505050505050565b6000806000604084860312156136ff57600080fd5b83356001600160401b0381111561371557600080fd5b613721868287016135d4565b909790965060209590950135949350505050565b60006020828403121561374757600080fd5b8135610fbd81613408565b602080825282518282018190526000919060409081850190868401855b8281101561379e578151805185528681015187860152850151858501526060909301929085019060010161376f565b5091979650505050505050565b600080604083850312156137be57600080fd5b82356137c981613408565b91506020830135801515811461344257600080fd5b6000806000604084860312156137f357600080fd5b83356001600160401b0381111561380957600080fd5b613815868287016135d4565b909450925061382890506020850161358b565b90509250925092565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f191681016001600160401b038111828210171561386f5761386f613831565b604052919050565b6000806000806080858703121561388d57600080fd5b843561389881613408565b93506020858101356138a981613408565b93506040860135925060608601356001600160401b03808211156138cc57600080fd5b818801915088601f8301126138e057600080fd5b8135818111156138f2576138f2613831565b613904601f8201601f19168501613847565b9150808252898482850101111561391a57600080fd5b808484018584013760008482840101525080935050505092959194509250565b60008060006040848603121561394f57600080fd5b83356001600160401b0381111561396557600080fd5b613971868287016135d4565b909450925050602084013561398581613408565b809150509250925092565b600080600080608085870312156139a657600080fd5b84359350602085013592506139bd6040860161358b565b9396929550929360600135925050565b6000806000606084860312156139e257600080fd5b83359250602080850135925060408501356001600160401b0380821115613a0857600080fd5b818701915087601f830112613a1c57600080fd5b813581811115613a2e57613a2e613831565b8060051b9150613a3f848301613847565b818152918301840191848101908a841115613a5957600080fd5b938501935b83851015613a7e57613a6f8561358b565b82529385019390850190613a5e565b8096505050505050509250925092565b60008060408385031215613aa157600080fd5b8235613aac81613408565b9150602083013561344281613408565b600181811c90821680613ad057607f821691505b602082108103613af057634e487b7160e01b600052602260045260246000fd5b50919050565b6020808252602d908201527f4552433732313a2063616c6c6572206973206e6f7420746f6b656e206f776e6560408201526c1c881bdc88185c1c1c9bdd9959609a1b606082015260800190565b634e487b7160e01b600052603260045260246000fd5b600060208284031215613b6b57600080fd5b610fbd8261358b565b6001600160a01b03199390931683526020830191909152604082015260600190565b634e487b7160e01b600052601160045260246000fd5b808201808211156109cf576109cf613b96565b602080825260129082015271696e76616c696420706172616d657465727360701b604082015260600190565b60208082526011908201527034b73b30b634b21037b832b930ba34b7b760791b604082015260600190565b6060808252810184905260006001600160fb1b03851115613c3657600080fd5b8460051b8087608085013760208301949094525060408101919091520160800192915050565b60008351613c6e818460208801613499565b835190830190613c82818360208801613499565b01949350505050565b80820281158282048414176109cf576109cf613b96565b60208082526025908201527f4552433732313a207472616e736665722066726f6d20696e636f72726563742060408201526437bbb732b960d91b606082015260800190565b60208082526032908201527f4552433732313a207472616e7366657220746f206e6f6e20455243373231526560408201527131b2b4bb32b91034b6b83632b6b2b73a32b960711b606082015260800190565b6001600160a01b0385811682528416602082015260408101839052608060608201819052600090613d6c908301846134bd565b9695505050505050565b600060208284031215613d8857600080fd5b8151610fbd8161344d56fea2646970667358221220838d751ed1580567aada864b691317738d1db46809b8ca2091226ee62191d65464736f6c63430008130033`
)

func TestLiquidStaking(t *testing.T) {
	r := require.New(t)
	// prepare blockchain
	ctx := context.Background()
	cfg := config.Default
	cfg.Chain.ProducerPrivKey = identityset.PrivateKey(1).HexString()
	cfg.Chain.EnableTrielessStateDB = false
	cfg.Genesis.InitBalanceMap[identityset.Address(1).String()] = "1000000000000000000000000000"

	bc, sf, dao, ap, indexer := prepareliquidStakingBlockchain(ctx, cfg, r)
	defer func() {
		r.NoError(bc.Stop(ctx))
	}()
	ctx = genesis.WithGenesisContext(context.Background(), bc.Genesis())

	// deploy smart contract
	deployAddr := blockindex.LiquidStakingContractAddress
	param := callParam{
		contractAddr: deployAddr,
		bytecode:     _liquidStakingContractByteCode,
		amount:       big.NewInt(0),
		gasLimit:     20000000,
		gasPrice:     big.NewInt(0),
		sk:           identityset.PrivateKey(1),
	}
	contractAddresses := deployContracts(bc, sf, dao, ap, &param, r)
	lsdABI, err := abi.JSON(strings.NewReader(blockindex.LiquidStakingContractABI))
	r.NoError(err)

	// init bucket type
	bucketTypes := []struct {
		amount   int64
		duration int64
	}{
		{10, 100},
		{10, 10},
		{100, 100},
		{100, 10},
	}
	params := []*callParam{}
	for i := range bucketTypes {
		data, err := lsdABI.Pack("addBucketType", big.NewInt(bucketTypes[i].amount), big.NewInt(bucketTypes[i].duration))
		r.NoError(err)
		param := callParam{
			contractAddr: contractAddresses,
			bytecode:     hex.EncodeToString(data),
			amount:       big.NewInt(0),
			gasLimit:     1000000,
			gasPrice:     big.NewInt(0),
			sk:           identityset.PrivateKey(1),
		}
		params = append(params, &param)
	}
	receipts, _ := writeContract(bc, sf, dao, ap, params, r)
	r.Len(receipts, len(params))
	for _, receipt := range receipts {
		r.EqualValues(iotextypes.ReceiptStatus_Success, receipt.Status)
	}

	simpleStake := func(candName string, amount, duration *big.Int) *blockindex.Bucket {
		return stake(lsdABI, bc, sf, dao, ap, contractAddresses, indexer, r, candName, amount, duration)
	}

	t.Run("stake", func(t *testing.T) {
		delegate := [12]byte{}
		copy(delegate[:], []byte("delegate2"))
		data, err := lsdABI.Pack("stake", big.NewInt(10), delegate)
		r.NoError(err)
		param := callParam{
			contractAddr: contractAddresses,
			bytecode:     hex.EncodeToString(data),
			amount:       big.NewInt(10),
			gasLimit:     1000000,
			gasPrice:     big.NewInt(0),
			sk:           identityset.PrivateKey(1),
		}
		receipts, blk := writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
		r.Len(receipts, 1)
		r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
		buckets, err := indexer.GetBuckets()
		r.NoError(err)
		slices.SortFunc(buckets, func(i, j *blockindex.Bucket) bool {
			return i.Index < j.Index
		})
		bt := buckets[len(buckets)-1]
		tokenID := bt.Index
		r.EqualValues(1, bt.Index)
		r.True(bt.AutoStake)
		r.Equal("delegate2", bt.Candidate)
		r.EqualValues(identityset.PrivateKey(1).PublicKey().Address().String(), bt.Owner.String())
		r.EqualValues(0, bt.StakedAmount.Cmp(big.NewInt(10)))
		r.EqualValues(10*cfg.Genesis.BlockInterval, bt.StakedDuration)
		r.EqualValues(blk.Timestamp().UTC(), bt.CreateTime)
		r.EqualValues(blk.Timestamp().UTC(), bt.StakeStartTime)
		r.EqualValues(time.Unix(0, 0).UTC(), bt.UnstakeStartTime)
		r.EqualValues(10, indexer.GetCandidateVotes("delegate2").Int64())

		t.Run("unlock", func(t *testing.T) {
			data, err = lsdABI.Pack("unlock0", big.NewInt(int64(bt.Index)))
			r.NoError(err)
			param = callParam{
				contractAddr: contractAddresses,
				bytecode:     hex.EncodeToString(data),
				amount:       big.NewInt(0),
				gasLimit:     1000000,
				gasPrice:     big.NewInt(0),
				sk:           identityset.PrivateKey(1),
			}
			receipts, blk = writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
			r.Len(receipts, 1)
			r.EqualValues("", receipts[0].ExecutionRevertMsg())
			r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
			bt, err := indexer.GetBucket(uint64(tokenID))
			r.NoError(err)
			r.EqualValues(blk.Timestamp().UTC(), bt.StakeStartTime)
			r.EqualValues(10, indexer.GetCandidateVotes("delegate2").Int64())

			t.Run("unstake", func(t *testing.T) {
				jumpBlocks(bc, 10, r)
				data, err = lsdABI.Pack("unstake", big.NewInt(int64(bt.Index)))
				r.NoError(err)
				param = callParam{
					contractAddr: contractAddresses,
					bytecode:     hex.EncodeToString(data),
					amount:       big.NewInt(0),
					gasLimit:     1000000,
					gasPrice:     big.NewInt(0),
					sk:           identityset.PrivateKey(1),
				}
				receipts, blk = writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
				r.Len(receipts, 1)
				r.EqualValues("", receipts[0].ExecutionRevertMsg())
				r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
				bt, err := indexer.GetBucket(uint64(tokenID))
				r.NoError(err)
				r.EqualValues(blk.Timestamp().UTC(), bt.UnstakeStartTime)
				r.EqualValues(0, indexer.GetCandidateVotes("delegate2").Int64())

				t.Run("withdraw", func(t *testing.T) {
					// jumpBlocks(bc, 3*24*3600/5, r)
					tokenID := bt.Index

					addr := common.BytesToAddress(identityset.PrivateKey(1).PublicKey().Bytes())
					data, err := lsdABI.Pack("withdraw", big.NewInt(int64(tokenID)), addr)
					r.NoError(err)
					param = callParam{
						contractAddr: contractAddresses,
						bytecode:     hex.EncodeToString(data),
						amount:       big.NewInt(0),
						gasLimit:     1000000,
						gasPrice:     big.NewInt(0),
						sk:           identityset.PrivateKey(1),
					}
					receipts, _ = writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
					r.Len(receipts, 1)
					// r.EqualValues("", receipts[0].ExecutionRevertMsg())
					// r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
					// bt, err = indexer.GetBucket(uint64(tokenID))
					// r.ErrorIs(err, blockindex.ErrBucketInfoNotExist)
				})
			})
		})
	})

	t.Run("lock & unlock", func(t *testing.T) {
		bt := simpleStake("delegate3", big.NewInt(10), big.NewInt(10))
		tokenID := bt.Index

		data, err := lsdABI.Pack("unlock0", big.NewInt(int64(bt.Index)))
		r.NoError(err)
		param = callParam{
			contractAddr: contractAddresses,
			bytecode:     hex.EncodeToString(data),
			amount:       big.NewInt(0),
			gasLimit:     1000000,
			gasPrice:     big.NewInt(0),
			sk:           identityset.PrivateKey(1),
		}
		receipts, _ = writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
		r.Len(receipts, 1)
		r.EqualValues("", receipts[0].ExecutionRevertMsg())
		r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)

		data, err = lsdABI.Pack("lock", big.NewInt(int64(bt.Index)), big.NewInt(10))
		r.NoError(err)
		param = callParam{
			contractAddr: contractAddresses,
			bytecode:     hex.EncodeToString(data),
			amount:       big.NewInt(0),
			gasLimit:     1000000,
			gasPrice:     big.NewInt(0),
			sk:           identityset.PrivateKey(1),
		}
		receipts, _ := writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
		r.Len(receipts, 1)
		r.EqualValues("", receipts[0].ExecutionRevertMsg())
		r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
		bt, err = indexer.GetBucket(uint64(tokenID))
		r.NoError(err)
		r.True(bt.AutoStake)
	})
	t.Run("merge", func(t *testing.T) {
		// stake 10 bucket
		candName := "delegate3"
		params := []*callParam{}
		for i := 0; i < 10; i++ {
			delegate := [12]byte{}
			copy(delegate[:], []byte(candName))
			data, err := lsdABI.Pack("stake", big.NewInt(10), delegate)
			r.NoError(err)
			param := callParam{
				contractAddr: contractAddresses,
				bytecode:     hex.EncodeToString(data),
				amount:       big.NewInt(10),
				gasLimit:     1000000,
				gasPrice:     big.NewInt(0),
				sk:           identityset.PrivateKey(1),
			}
			params = append(params, &param)
		}
		receipts, _ := writeContract(bc, sf, dao, ap, params, r)
		r.Len(receipts, len(params))
		for _, receipt := range receipts {
			r.EqualValues(iotextypes.ReceiptStatus_Success, receipt.Status)
		}
		buckets, err := indexer.GetBuckets()
		r.NoError(err)
		slices.SortFunc(buckets, func(i, j *blockindex.Bucket) bool {
			return i.Index < j.Index
		})
		r.True(len(buckets) >= 10)
		// merge
		newBuckets := buckets[len(buckets)-10:]
		tokens := []*big.Int{}
		for _, bucket := range newBuckets {
			tokens = append(tokens, big.NewInt(int64(bucket.Index)))
		}
		data, err := lsdABI.Pack("merge", tokens, big.NewInt(100))
		r.NoError(err)
		param := callParam{
			contractAddr: contractAddresses,
			bytecode:     hex.EncodeToString(data),
			amount:       big.NewInt(0),
			gasLimit:     1000000,
			gasPrice:     big.NewInt(0),
			sk:           identityset.PrivateKey(1),
		}
		receipts, _ = writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
		r.Len(receipts, 1)
		r.EqualValues("", receipts[0].ExecutionRevertMsg())
		r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
		for i := range newBuckets {
			if i == 0 {
				bt, err := indexer.GetBucket(uint64(newBuckets[i].Index))
				r.NoError(err)
				r.EqualValues(100*cfg.Genesis.BlockInterval, bt.StakedDuration)
			} else {
				_, err := indexer.GetBucket(uint64(newBuckets[i].Index))
				r.ErrorIs(err, blockindex.ErrBucketInfoNotExist)
			}
		}
	})

	t.Run("extend duration", func(t *testing.T) {
		// stake
		bt := simpleStake("delegate3", big.NewInt(10), big.NewInt(10))
		tokenID := bt.Index
		r.EqualValues(10*cfg.Genesis.BlockInterval, bt.StakedDuration)
		// extend duration
		data, err := lsdABI.Pack("extendDuration", big.NewInt(int64(tokenID)), big.NewInt(100))
		r.NoError(err)
		param = callParam{
			contractAddr: contractAddresses,
			bytecode:     hex.EncodeToString(data),
			amount:       big.NewInt(0),
			gasLimit:     1000000,
			gasPrice:     big.NewInt(0),
			sk:           identityset.PrivateKey(1),
		}
		receipts, _ = writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
		r.Len(receipts, 1)
		r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
		bt, err = indexer.GetBucket(uint64(tokenID))
		r.NoError(err)
		r.EqualValues(100*cfg.Genesis.BlockInterval, bt.StakedDuration)
	})

	t.Run("increase amount", func(t *testing.T) {
		bt := simpleStake("delegate4", big.NewInt(10), big.NewInt(10))
		tokenID := bt.Index

		data, err := lsdABI.Pack("increaseAmount", big.NewInt(int64(tokenID)), big.NewInt(100))
		r.NoError(err)
		param = callParam{
			contractAddr: contractAddresses,
			bytecode:     hex.EncodeToString(data),
			amount:       big.NewInt(90),
			gasLimit:     1000000,
			gasPrice:     big.NewInt(0),
			sk:           identityset.PrivateKey(1),
		}
		receipts, _ = writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
		r.Len(receipts, 1)
		r.EqualValues("", receipts[0].ExecutionRevertMsg())
		r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
		bt, err = indexer.GetBucket(uint64(tokenID))
		r.NoError(err)
		r.EqualValues(100, bt.StakedAmount.Int64())
	})

	t.Run("change delegate", func(t *testing.T) {
		bt := simpleStake("delegate5", big.NewInt(10), big.NewInt(10))
		tokenID := bt.Index
		r.EqualValues("delegate5", bt.Candidate)

		delegate := [12]byte{}
		copy(delegate[:], []byte("delegate6"))
		data, err := lsdABI.Pack("changeDelegate", big.NewInt(int64(tokenID)), delegate)
		r.NoError(err)
		param = callParam{
			contractAddr: contractAddresses,
			bytecode:     hex.EncodeToString(data),
			amount:       big.NewInt(0),
			gasLimit:     1000000,
			gasPrice:     big.NewInt(0),
			sk:           identityset.PrivateKey(1),
		}
		receipts, _ = writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
		r.Len(receipts, 1)
		r.EqualValues("", receipts[0].ExecutionRevertMsg())
		r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
		bt, err = indexer.GetBucket(uint64(tokenID))
		r.NoError(err)
		r.EqualValues("delegate6", bt.Candidate)
	})

}

func prepareliquidStakingBlockchain(ctx context.Context, cfg config.Config, r *require.Assertions) (blockchain.Blockchain, factory.Factory, blockdao.BlockDAO, actpool.ActPool, blockindex.LiquidStakingIndexer) {
	defer func() {
		delete(cfg.Plugins, config.GatewayPlugin)
	}()
	cfg.Plugins[config.GatewayPlugin] = true
	cfg.Chain.EnableAsyncIndexWrite = false
	cfg.Genesis.EnableGravityChainVoting = false
	testTriePath, err := testutil.PathOfTempFile("trie")
	r.NoError(err)
	defer testutil.CleanupPath(testTriePath)
	testLiquidStakeIndexerPath, err := testutil.PathOfTempFile("liquidstakeindexer")
	r.NoError(err)
	defer testutil.CleanupPath(testLiquidStakeIndexerPath)

	cfg.Chain.TrieDBPath = testTriePath
	cfg.ActPool.MinGasPriceStr = "0"

	cfg.Genesis.Blockchain.AleutianBlockHeight = 0
	cfg.Genesis.Blockchain.BeringBlockHeight = 0

	cfg.Genesis.HawaiiBlockHeight = 0

	cfg.Genesis.CookBlockHeight = 0
	cfg.Genesis.DardanellesBlockHeight = 0
	cfg.Genesis.DaytonaBlockHeight = 0
	cfg.Genesis.EasterBlockHeight = 0
	cfg.Genesis.FbkMigrationBlockHeight = 0
	cfg.Genesis.FairbankBlockHeight = 0
	cfg.Genesis.GreenlandBlockHeight = 0
	cfg.Genesis.IcelandBlockHeight = 0

	// London is enabled at okhotsk height
	cfg.Genesis.Blockchain.JutlandBlockHeight = 0
	cfg.Genesis.Blockchain.KamchatkaBlockHeight = 0
	cfg.Genesis.Blockchain.LordHoweBlockHeight = 0
	cfg.Genesis.Blockchain.MidwayBlockHeight = 0
	cfg.Genesis.Blockchain.NewfoundlandBlockHeight = 0
	cfg.Genesis.Blockchain.OkhotskBlockHeight = 0

	registry := protocol.NewRegistry()
	acc := account.NewProtocol(rewarding.DepositGas)
	r.NoError(acc.Register(registry))
	rp := rolldpos.NewProtocol(cfg.Genesis.NumCandidateDelegates, cfg.Genesis.NumDelegates, cfg.Genesis.NumSubEpochs)
	r.NoError(rp.Register(registry))
	// create state factory
	var sf factory.Factory
	var daoKV db.KVStore

	factoryCfg := factory.GenerateConfig(cfg.Chain, cfg.Genesis)
	if cfg.Chain.EnableTrielessStateDB {
		if cfg.Chain.EnableStateDBCaching {
			daoKV, err = db.CreateKVStoreWithCache(cfg.DB, cfg.Chain.TrieDBPath, cfg.Chain.StateDBCacheSize)
		} else {
			daoKV, err = db.CreateKVStore(cfg.DB, cfg.Chain.TrieDBPath)
		}
		r.NoError(err)
		sf, err = factory.NewStateDB(factoryCfg, daoKV, factory.RegistryStateDBOption(registry))
	} else {
		sf, err = factory.NewFactory(factoryCfg, db.NewMemKVStore(), factory.RegistryOption(registry))
	}
	r.NoError(err)
	ap, err := actpool.NewActPool(cfg.Genesis, sf, cfg.ActPool)
	r.NoError(err)
	// create indexer
	indexer, err := blockindex.NewIndexer(db.NewMemKVStore(), cfg.Genesis.Hash())
	r.NoError(err)
	cc := cfg.DB
	cc.DbPath = testLiquidStakeIndexerPath
	liquidStakeIndexer := blockindex.NewLiquidStakingIndexer(db.NewBoltDB(cc), cfg.Genesis.BlockInterval)
	// create BlockDAO
	dao := blockdao.NewBlockDAOInMemForTest([]blockdao.BlockIndexer{sf, indexer, liquidStakeIndexer})
	r.NotNil(dao)
	bc := blockchain.NewBlockchain(
		cfg.Chain,
		cfg.Genesis,
		dao,
		factory.NewMinter(sf, ap),
		blockchain.BlockValidatorOption(block.NewValidator(
			sf,
			protocol.NewGenericValidator(sf, accountutil.AccountState),
		)),
	)
	// reward := rewarding.NewProtocol(cfg.Genesis.Rewarding)
	// r.NoError(reward.Register(registry))

	r.NotNil(bc)
	execution := execution.NewProtocol(dao.GetBlockHash, rewarding.DepositGas)
	r.NoError(execution.Register(registry))
	r.NoError(bc.Start(ctx))

	return bc, sf, dao, ap, liquidStakeIndexer
}

func deployContracts(
	bc blockchain.Blockchain,
	sf factory.Factory,
	dao blockdao.BlockDAO,
	ap actpool.ActPool,
	param *callParam,
	r *require.Assertions,
) (contractAddresses string) {
	sk := param.sk
	bytecode, err := hex.DecodeString(param.bytecode)
	r.NoError(err)
	state, err := accountutil.AccountState(genesis.WithGenesisContext(context.Background(), bc.Genesis()), sf, sk.PublicKey().Address())
	r.NoError(err)
	nonce := state.PendingNonce()
	amount := param.amount
	gasLimit := param.gasLimit
	gasPrice := param.gasPrice
	exec, err := action.NewExecutionWithAccessList(action.EmptyAddress, nonce, amount, gasLimit, gasPrice, bytecode, nil)
	r.NoError(err)
	builder := &action.EnvelopeBuilder{}
	elp := builder.SetAction(exec).
		SetNonce(exec.Nonce()).
		SetGasLimit(gasLimit).
		SetGasPrice(gasPrice).
		Build()
	selp, err := action.Sign(elp, sk)
	r.NoError(err)
	err = ap.Add(context.Background(), selp)
	r.NoError(err)
	selpHash, err := selp.Hash()

	blk, err := bc.MintNewBlock(testutil.TimestampNow())
	r.NoError(err)
	err = bc.CommitBlock(blk)
	r.NoError(err)

	receipt, err := dao.GetReceiptByActionHash(selpHash, blk.Height())
	r.NoError(err)
	r.NotNil(receipt)
	r.Equal(uint64(iotextypes.ReceiptStatus_Success), receipt.Status)

	return receipt.ContractAddress
}

type callParam struct {
	contractAddr string
	bytecode     string
	amount       *big.Int
	gasLimit     uint64
	gasPrice     *big.Int
	sk           crypto.PrivateKey
}

func writeContract(bc blockchain.Blockchain,
	sf factory.Factory,
	dao blockdao.BlockDAO,
	ap actpool.ActPool,
	params []*callParam,
	r *require.Assertions,
) ([]*action.Receipt, *block.Block) {
	nonces := map[string]uint64{}
	hashes := []hash.Hash256{}
	for _, param := range params {
		nonce := uint64(1)
		var ok bool
		sk := param.sk
		executor := sk.PublicKey().Address()
		if nonce, ok = nonces[executor.String()]; !ok {
			state, err := accountutil.AccountState(genesis.WithGenesisContext(context.Background(), bc.Genesis()), sf, executor)
			r.NoError(err)
			nonce = state.PendingNonce()
		} else {
			nonce++
		}
		nonces[executor.String()] = nonce

		amount := param.amount
		gasLimit := param.gasLimit
		gasPrice := param.gasPrice
		bytecode, err := hex.DecodeString(param.bytecode)
		r.NoError(err)
		exec, err := action.NewExecutionWithAccessList(param.contractAddr, nonce, amount, gasLimit, gasPrice, bytecode, nil)
		r.NoError(err)
		builder := &action.EnvelopeBuilder{}
		elp := builder.SetAction(exec).
			SetNonce(exec.Nonce()).
			SetGasLimit(gasLimit).
			SetGasPrice(gasPrice).
			Build()
		selp, err := action.Sign(elp, sk)
		r.NoError(err)
		err = ap.Add(context.Background(), selp)
		r.NoError(err)
		selpHash, err := selp.Hash()
		hashes = append(hashes, selpHash)
	}

	blk, err := bc.MintNewBlock(testutil.TimestampNow())
	r.NoError(err)
	err = bc.CommitBlock(blk)
	r.NoError(err)

	receipts := []*action.Receipt{}
	for _, hash := range hashes {
		receipt, err := dao.GetReceiptByActionHash(hash, blk.Height())
		r.NoError(err)
		receipts = append(receipts, receipt)
	}
	return receipts, blk
}

func jumpBlocks(bc blockchain.Blockchain, count int, r *require.Assertions) {
	for i := 0; i < count; i++ {
		blk, err := bc.MintNewBlock(testutil.TimestampNow())
		r.NoError(err)
		err = bc.CommitBlock(blk)
		r.NoError(err)
	}
}

func stake(lsdABI abi.ABI, bc blockchain.Blockchain, sf factory.Factory, dao blockdao.BlockDAO, ap actpool.ActPool, contractAddresses string, indexer blockindex.LiquidStakingIndexer, r *require.Assertions, candName string, amount, duration *big.Int) *blockindex.Bucket {
	delegate := [12]byte{}
	copy(delegate[:], []byte(candName))
	data, err := lsdABI.Pack("stake", duration, delegate)
	r.NoError(err)
	param := callParam{
		contractAddr: contractAddresses,
		bytecode:     hex.EncodeToString(data),
		amount:       amount,
		gasLimit:     1000000,
		gasPrice:     big.NewInt(0),
		sk:           identityset.PrivateKey(1),
	}
	receipts, _ := writeContract(bc, sf, dao, ap, []*callParam{&param}, r)
	r.Len(receipts, 1)
	r.EqualValues(iotextypes.ReceiptStatus_Success, receipts[0].Status)
	buckets, err := indexer.GetBuckets()
	r.NoError(err)
	slices.SortFunc(buckets, func(i, j *blockindex.Bucket) bool {
		return i.Index < j.Index
	})
	bt := buckets[len(buckets)-1]
	return bt
}
