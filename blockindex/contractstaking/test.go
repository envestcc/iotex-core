package contractstaking

import (
	"encoding/json"
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/iotexproject/go-pkgs/hash"
	"github.com/stretchr/testify/require"

	"github.com/iotexproject/iotex-core/action"
)

func TestXxx(t *testing.T) {
	r := require.New(t)
	logsJSON := `[
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000009ace9968545089893208f35a81569fa81cd24f7c"
		  ],
		  "data": "0x0000000000000000000000000000000000000000000000056bc75e2d63100000",
		  "address": "0x956a03eceb344ea15a6cbe8949088992fad88628"
		},
		{
		  "topics": [
			"0x30385c845b448a36257a6a1716e6ad2e1bc2cbe333cde1e69fe849ad6511adfe"
		  ],
		  "data": "0x0000000000000000000000009ace9968545089893208f35a81569fa81cd24f7c0000000000000000000000000000000000000000000000056bc75e2d63100000",
		  "address": "0xa479659f378d54168cd7859f5025133382edb3c5"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x000000000000000000000000000000000000000000000000000000000000005d"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0x17700ceb1658b18206f427c1578048e87504106b14ec69e9b4586d9a95174a32",
			"0x000000000000000000000000000000000000000000000000000000000000005d"
		  ],
		  "data": "0x000000000000000000000000ac82586b613d10a33df00835ac6dad85419523340000000000000000000000000000000000000000000000056bc75e2d631000000000000000000000000000000000000000000000000000000000000000008700",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xc49cabe9d2bbfea8d9f51b0961c30a1081ff6fd3c4d6a9182cd65de8cea2df00"
		  ],
		  "data": "0x000000000000000000000000000000000000000000000000000000000000005d0000000000000000000000000000000000000000000000056bc75e2d63100000000000000000000000000000ac82586b613d10a33df00835ac6dad85419523340000000000000000000000000000000000000000000000000000000000000001",
		  "address": "0xa479659f378d54168cd7859f5025133382edb3c5"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000005d"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000005c"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000005b"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x000000000000000000000000000000000000000000000000000000000000005a"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000059"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000058"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000057"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000056"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
			"0x000000000000000000000000a479659f378d54168cd7859f5025133382edb3c5",
			"0x0000000000000000000000000000000000000000000000000000000000000000",
			"0x0000000000000000000000000000000000000000000000000000000000000055"
		  ],
		  "data": "0x",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0xb3f4c8ca702dbbd32d9a25ce17b1942a5060284d9d69fc4fcac8fb0397891b12"
		  ],
		  "data": "0x000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000003635c9adc5dea000000000000000000000000000000000000000000000000000000000000000008700000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000550000000000000000000000000000000000000000000000000000000000000056000000000000000000000000000000000000000000000000000000000000005700000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000059000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000005b000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000000000000000000000000000000000000005d",
		  "address": "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f"
		},
		{
		  "topics": [
			"0x0c834fb4dca660c7c0016cf0716f341c5bd26cd91f18223279e15942b2fe0cda"
		  ],
		  "data": "0x000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000003635c9adc5dea000000000000000000000000000000000000000000000000000000000000000000000",
		  "address": "0xa479659f378d54168cd7859f5025133382edb3c5"
		}
	  ]`
	logs := []struct {
		Topics  []string `json:"topics"`
		Data    string   `json:"data"`
		Address string   `json:"address"`
	}{}
	err := json.Unmarshal([]byte(logsJSON), &logs)
	r.NoError(err)

	for i := range logs {
		if logs[i].Address != "0x52ab0fe2c3a94644de0888a3ba9ea1443672e61f" {
			continue
		}
		topics := make([]hash.Hash256, 0)
		for _, t := range logs[i].Topics {
			topics = append(topics, hash.Hash256(common.HexToHash(t)))
		}
		data := common.FromHex(logs[i].Data)
		// addr := common.HexToAddress(logs[i].Address)

		abiEvent, err := _stakingInterface.EventByID(common.HexToHash(logs[i].Topics[0]))
		r.NoError(err)
		// t.Logf("%+v", abiEvent)

		param, err := unpackEventParam(abiEvent, &action.Log{
			Topics: topics,
			Data:   data,
		})
		r.NoError(err)
		t.Logf("%+v, %+v", abiEvent.Name, param)
	}
}
